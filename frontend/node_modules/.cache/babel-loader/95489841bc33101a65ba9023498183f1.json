{"ast":null,"code":"import _classCallCheck from \"C:/Users/jason/Documents/GitHub/build-viewer/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/classCallCheck.js\";\nimport _createClass from \"C:/Users/jason/Documents/GitHub/build-viewer/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createClass.js\";\nimport _inherits from \"C:/Users/jason/Documents/GitHub/build-viewer/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/inherits.js\";\nimport _createSuper from \"C:/Users/jason/Documents/GitHub/build-viewer/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/createSuper.js\";\nimport TempNode from '../core/TempNode.js';\nimport ModelNode from '../accessors/ModelNode.js';\nimport { ShaderNode, dFdx, dFdy, cross, add, mul, max, dot, cond, inversesqrt, equal, normalize, sub, join, positionView, normalView, uv } from '../ShaderNode.js';\nimport { TangentSpaceNormalMap, ObjectSpaceNormalMap } from 'three'; // http://www.thetenthplanet.de/archives/1180\n\nvar perturbNormal2ArbNode = new ShaderNode(function (inputs) {\n  var eye_pos = inputs.eye_pos,\n      surf_norm = inputs.surf_norm,\n      mapN = inputs.mapN,\n      faceDirection = inputs.faceDirection,\n      uv = inputs.uv;\n  var q0 = dFdx(eye_pos.xyz);\n  var q1 = dFdy(eye_pos.xyz);\n  var st0 = dFdx(uv.st);\n  var st1 = dFdy(uv.st);\n  var N = surf_norm; // normalized\n\n  var q1perp = cross(q1, N);\n  var q0perp = cross(N, q0);\n  var T = add(mul(q1perp, st0.x), mul(q0perp, st1.x));\n  var B = add(mul(q1perp, st0.y), mul(q0perp, st1.y));\n  var det = max(dot(T, T), dot(B, B));\n  var scale = cond(equal(det, 0), 0, mul(faceDirection, inversesqrt(det)));\n  return normalize(add(mul(T, mul(mapN.x, scale)), mul(B, mul(mapN.y, scale)), mul(N, mapN.z)));\n});\n\nvar NormalMapNode = /*#__PURE__*/function (_TempNode) {\n  _inherits(NormalMapNode, _TempNode);\n\n  var _super = _createSuper(NormalMapNode);\n\n  function NormalMapNode(node) {\n    var _this;\n\n    var scaleNode = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : null;\n\n    _classCallCheck(this, NormalMapNode);\n\n    _this = _super.call(this, 'vec3');\n    _this.node = node;\n    _this.scaleNode = scaleNode;\n    _this.normalMapType = TangentSpaceNormalMap;\n    return _this;\n  }\n\n  _createClass(NormalMapNode, [{\n    key: \"generate\",\n    value: function generate(builder) {\n      var type = this.getNodeType(builder);\n      var normalMapType = this.normalMapType,\n          scaleNode = this.scaleNode;\n      var normalOP = mul(this.node, 2.0);\n      var normalMap = sub(normalOP, 1.0);\n\n      if (scaleNode !== null) {\n        var normalMapScale = mul(normalMap.xy, scaleNode);\n        normalMap = join(normalMapScale, normalMap.z);\n      }\n\n      if (normalMapType === ObjectSpaceNormalMap) {\n        var vertexNormalNode = mul(new ModelNode(ModelNode.NORMAL_MATRIX), normalMap);\n        var normal = normalize(vertexNormalNode);\n        return normal.build(builder, type);\n      } else if (normalMapType === TangentSpaceNormalMap) {\n        var perturbNormal2ArbCall = perturbNormal2ArbNode({\n          eye_pos: positionView,\n          surf_norm: normalView,\n          mapN: normalMap,\n          faceDirection: 1.0,\n          uv: uv()\n        });\n        return perturbNormal2ArbCall.build(builder, type);\n      }\n    }\n  }]);\n\n  return NormalMapNode;\n}(TempNode);\n\nexport default NormalMapNode;","map":{"version":3,"sources":["C:/Users/jason/Documents/GitHub/build-viewer/frontend/node_modules/three-stdlib/nodes/display/NormalMapNode.js"],"names":["TempNode","ModelNode","ShaderNode","dFdx","dFdy","cross","add","mul","max","dot","cond","inversesqrt","equal","normalize","sub","join","positionView","normalView","uv","TangentSpaceNormalMap","ObjectSpaceNormalMap","perturbNormal2ArbNode","inputs","eye_pos","surf_norm","mapN","faceDirection","q0","xyz","q1","st0","st","st1","N","q1perp","q0perp","T","x","B","y","det","scale","z","NormalMapNode","node","scaleNode","normalMapType","builder","type","getNodeType","normalOP","normalMap","normalMapScale","xy","vertexNormalNode","NORMAL_MATRIX","normal","build","perturbNormal2ArbCall"],"mappings":";;;;AAAA,OAAOA,QAAP,MAAqB,qBAArB;AACA,OAAOC,SAAP,MAAsB,2BAAtB;AACA,SAASC,UAAT,EAAqBC,IAArB,EAA2BC,IAA3B,EAAiCC,KAAjC,EAAwCC,GAAxC,EAA6CC,GAA7C,EAAkDC,GAAlD,EAAuDC,GAAvD,EAA4DC,IAA5D,EAAkEC,WAAlE,EAA+EC,KAA/E,EAAsFC,SAAtF,EAAiGC,GAAjG,EAAsGC,IAAtG,EAA4GC,YAA5G,EAA0HC,UAA1H,EAAsIC,EAAtI,QAAgJ,kBAAhJ;AACA,SAASC,qBAAT,EAAgCC,oBAAhC,QAA4D,OAA5D,C,CAEA;;AAEA,IAAMC,qBAAqB,GAAG,IAAInB,UAAJ,CAAe,UAAAoB,MAAM,EAAI;AACrD,MACEC,OADF,GAMID,MANJ,CACEC,OADF;AAAA,MAEEC,SAFF,GAMIF,MANJ,CAEEE,SAFF;AAAA,MAGEC,IAHF,GAMIH,MANJ,CAGEG,IAHF;AAAA,MAIEC,aAJF,GAMIJ,MANJ,CAIEI,aAJF;AAAA,MAKER,EALF,GAMII,MANJ,CAKEJ,EALF;AAOA,MAAMS,EAAE,GAAGxB,IAAI,CAACoB,OAAO,CAACK,GAAT,CAAf;AACA,MAAMC,EAAE,GAAGzB,IAAI,CAACmB,OAAO,CAACK,GAAT,CAAf;AACA,MAAME,GAAG,GAAG3B,IAAI,CAACe,EAAE,CAACa,EAAJ,CAAhB;AACA,MAAMC,GAAG,GAAG5B,IAAI,CAACc,EAAE,CAACa,EAAJ,CAAhB;AACA,MAAME,CAAC,GAAGT,SAAV,CAZqD,CAYhC;;AAErB,MAAMU,MAAM,GAAG7B,KAAK,CAACwB,EAAD,EAAKI,CAAL,CAApB;AACA,MAAME,MAAM,GAAG9B,KAAK,CAAC4B,CAAD,EAAIN,EAAJ,CAApB;AACA,MAAMS,CAAC,GAAG9B,GAAG,CAACC,GAAG,CAAC2B,MAAD,EAASJ,GAAG,CAACO,CAAb,CAAJ,EAAqB9B,GAAG,CAAC4B,MAAD,EAASH,GAAG,CAACK,CAAb,CAAxB,CAAb;AACA,MAAMC,CAAC,GAAGhC,GAAG,CAACC,GAAG,CAAC2B,MAAD,EAASJ,GAAG,CAACS,CAAb,CAAJ,EAAqBhC,GAAG,CAAC4B,MAAD,EAASH,GAAG,CAACO,CAAb,CAAxB,CAAb;AACA,MAAMC,GAAG,GAAGhC,GAAG,CAACC,GAAG,CAAC2B,CAAD,EAAIA,CAAJ,CAAJ,EAAY3B,GAAG,CAAC6B,CAAD,EAAIA,CAAJ,CAAf,CAAf;AACA,MAAMG,KAAK,GAAG/B,IAAI,CAACE,KAAK,CAAC4B,GAAD,EAAM,CAAN,CAAN,EAAgB,CAAhB,EAAmBjC,GAAG,CAACmB,aAAD,EAAgBf,WAAW,CAAC6B,GAAD,CAA3B,CAAtB,CAAlB;AACA,SAAO3B,SAAS,CAACP,GAAG,CAACC,GAAG,CAAC6B,CAAD,EAAI7B,GAAG,CAACkB,IAAI,CAACY,CAAN,EAASI,KAAT,CAAP,CAAJ,EAA6BlC,GAAG,CAAC+B,CAAD,EAAI/B,GAAG,CAACkB,IAAI,CAACc,CAAN,EAASE,KAAT,CAAP,CAAhC,EAAyDlC,GAAG,CAAC0B,CAAD,EAAIR,IAAI,CAACiB,CAAT,CAA5D,CAAJ,CAAhB;AACD,CArB6B,CAA9B;;IAuBMC,a;;;;;AACJ,yBAAYC,IAAZ,EAAoC;AAAA;;AAAA,QAAlBC,SAAkB,uEAAN,IAAM;;AAAA;;AAClC,8BAAM,MAAN;AACA,UAAKD,IAAL,GAAYA,IAAZ;AACA,UAAKC,SAAL,GAAiBA,SAAjB;AACA,UAAKC,aAAL,GAAqB3B,qBAArB;AAJkC;AAKnC;;;;WAED,kBAAS4B,OAAT,EAAkB;AAChB,UAAMC,IAAI,GAAG,KAAKC,WAAL,CAAiBF,OAAjB,CAAb;AACA,UACED,aADF,GAGI,IAHJ,CACEA,aADF;AAAA,UAEED,SAFF,GAGI,IAHJ,CAEEA,SAFF;AAIA,UAAMK,QAAQ,GAAG3C,GAAG,CAAC,KAAKqC,IAAN,EAAY,GAAZ,CAApB;AACA,UAAIO,SAAS,GAAGrC,GAAG,CAACoC,QAAD,EAAW,GAAX,CAAnB;;AAEA,UAAIL,SAAS,KAAK,IAAlB,EAAwB;AACtB,YAAMO,cAAc,GAAG7C,GAAG,CAAC4C,SAAS,CAACE,EAAX,EAAeR,SAAf,CAA1B;AACAM,QAAAA,SAAS,GAAGpC,IAAI,CAACqC,cAAD,EAAiBD,SAAS,CAACT,CAA3B,CAAhB;AACD;;AAED,UAAII,aAAa,KAAK1B,oBAAtB,EAA4C;AAC1C,YAAMkC,gBAAgB,GAAG/C,GAAG,CAAC,IAAIN,SAAJ,CAAcA,SAAS,CAACsD,aAAxB,CAAD,EAAyCJ,SAAzC,CAA5B;AACA,YAAMK,MAAM,GAAG3C,SAAS,CAACyC,gBAAD,CAAxB;AACA,eAAOE,MAAM,CAACC,KAAP,CAAaV,OAAb,EAAsBC,IAAtB,CAAP;AACD,OAJD,MAIO,IAAIF,aAAa,KAAK3B,qBAAtB,EAA6C;AAClD,YAAMuC,qBAAqB,GAAGrC,qBAAqB,CAAC;AAClDE,UAAAA,OAAO,EAAEP,YADyC;AAElDQ,UAAAA,SAAS,EAAEP,UAFuC;AAGlDQ,UAAAA,IAAI,EAAE0B,SAH4C;AAIlDzB,UAAAA,aAAa,EAAE,GAJmC;AAKlDR,UAAAA,EAAE,EAAEA,EAAE;AAL4C,SAAD,CAAnD;AAOA,eAAOwC,qBAAqB,CAACD,KAAtB,CAA4BV,OAA5B,EAAqCC,IAArC,CAAP;AACD;AACF;;;;EApCyBhD,Q;;AAwC5B,eAAe2C,aAAf","sourcesContent":["import TempNode from '../core/TempNode.js';\nimport ModelNode from '../accessors/ModelNode.js';\nimport { ShaderNode, dFdx, dFdy, cross, add, mul, max, dot, cond, inversesqrt, equal, normalize, sub, join, positionView, normalView, uv } from '../ShaderNode.js';\nimport { TangentSpaceNormalMap, ObjectSpaceNormalMap } from 'three';\n\n// http://www.thetenthplanet.de/archives/1180\n\nconst perturbNormal2ArbNode = new ShaderNode(inputs => {\n  const {\n    eye_pos,\n    surf_norm,\n    mapN,\n    faceDirection,\n    uv\n  } = inputs;\n  const q0 = dFdx(eye_pos.xyz);\n  const q1 = dFdy(eye_pos.xyz);\n  const st0 = dFdx(uv.st);\n  const st1 = dFdy(uv.st);\n  const N = surf_norm; // normalized\n\n  const q1perp = cross(q1, N);\n  const q0perp = cross(N, q0);\n  const T = add(mul(q1perp, st0.x), mul(q0perp, st1.x));\n  const B = add(mul(q1perp, st0.y), mul(q0perp, st1.y));\n  const det = max(dot(T, T), dot(B, B));\n  const scale = cond(equal(det, 0), 0, mul(faceDirection, inversesqrt(det)));\n  return normalize(add(mul(T, mul(mapN.x, scale)), mul(B, mul(mapN.y, scale)), mul(N, mapN.z)));\n});\n\nclass NormalMapNode extends TempNode {\n  constructor(node, scaleNode = null) {\n    super('vec3');\n    this.node = node;\n    this.scaleNode = scaleNode;\n    this.normalMapType = TangentSpaceNormalMap;\n  }\n\n  generate(builder) {\n    const type = this.getNodeType(builder);\n    const {\n      normalMapType,\n      scaleNode\n    } = this;\n    const normalOP = mul(this.node, 2.0);\n    let normalMap = sub(normalOP, 1.0);\n\n    if (scaleNode !== null) {\n      const normalMapScale = mul(normalMap.xy, scaleNode);\n      normalMap = join(normalMapScale, normalMap.z);\n    }\n\n    if (normalMapType === ObjectSpaceNormalMap) {\n      const vertexNormalNode = mul(new ModelNode(ModelNode.NORMAL_MATRIX), normalMap);\n      const normal = normalize(vertexNormalNode);\n      return normal.build(builder, type);\n    } else if (normalMapType === TangentSpaceNormalMap) {\n      const perturbNormal2ArbCall = perturbNormal2ArbNode({\n        eye_pos: positionView,\n        surf_norm: normalView,\n        mapN: normalMap,\n        faceDirection: 1.0,\n        uv: uv()\n      });\n      return perturbNormal2ArbCall.build(builder, type);\n    }\n  }\n\n}\n\nexport default NormalMapNode;\n"]},"metadata":{},"sourceType":"module"}